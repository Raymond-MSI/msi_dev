<?php
if((isset($property)) && ($property == 1)) {
    $version = '1.0';
    $author = 'Syamsul Arham';
} else {
    $modulename = "Employee List";
    $userpermission = useraccess($modulename); 
    if(USERPERMISSION=="7b7bc2512ee1fedcd76bdc68926d4f7b" || USERPERMISSION=="dbf36ff3e3827639223983ee8ac47b42" || USERPERMISSION=="726ea0dd998698e8a87f8e344d373533" || USERPERMISSION=="5898299487c5b9cdbe7d61809fd20213" || USERPERMISSION=="335a66c239a137964a33e8c60b24e3d9" || USERPERMISSION=="0162bce636a63c3ae499224203e06ed0") {

        $tblname = 'cfg_web';
        $condition = 'config_key="MODULE_HCM"';
        $setupDB = $DB->get_data($tblname, $condition);
        $dsetupDB = $setupDB[0];
        if($setupDB[2]>0) {
            $params = get_params($dsetupDB['params']);
            $hostname = $params['database']['hostname'];
            $username = $params['database']['username'];
            $userpassword = $params['database']['userpassword'];
            $database = $params['database']['database_name'];

            $DPNAV = new Databases($hostname, $username, $userpassword, $database);
            $tblname = "view_employees";
            ?>
            <script> 
                $(document).ready(function() {
                    var table = $('#<?php echo $tblname; ?>').DataTable( {
                        dom: 'Blfrtip',
                        "order": [
                            [ 10 , "asc"]
                        ],
                        select: {
                            style: 'single'
                        },
                        buttons: [
                            {
                                extend: 'colvis',
                                text: "<i class='fa fa-columns'></i>",
                                collectionLayout: 'fixed four-column',
                                enabled: false
                            },
                            {
                                text: "<i class='fa fa-plus'></i>",
                                action: function () {
                                    var rownumber = table.rows({selected: true}).indexes();
                                    var employee_email = table.cell( rownumber,2 ).data();
                                    window.location.href = "index.php?mod=users&act=add&employee_email="+employee_email+"&submit=Submit";
                                }
                            },
                            {
                                extend: 'excelHtml5',
                                text: "<i class='fa fa-download'></i>",
                                title: 'Employee List'
                            },
                        ],
                        "columnDefs": [
                            {
                                "targets": [2,4,8,13],
                                "visible": false
                            }
                        ]
                    });
                } );
            </script>


            <div class="col-lg-12">

                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Select STructure</h6>
                        <?php spinner(); ?>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-2 border-end">
                                <div class="row mb-3">
                                    <div class="col-lg-12 border-bottom">
                                        <b>Filter</b> <i class="fas fa-question-circle" data-bs-toggle="popover" data-bs-trigger="focus" title="Hasil filter data dibatasi maksimum 1.000 data yang terbaru. Maksimalkan kata kunci untuk mendapatkan data yang maksimal."></i>
                                    </div>
                                </div>
                                <form name="form" method="get" action="index.php">
                                    <div class="row mb-3">
                                        <div class="col-lg-12">Departement:</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-lg-12">
                                            <select class="form-select" name="organization" aria-label="Default select example">
                                                <?php
                                                $mdlname = "HCM";
                                                $DBHCM = get_conn($mdlname);
                                                // $mysql = "SELECT `organization_name` FROM `sa_mst_organization` group by `organization_name` order by `organization_name`";
                                                // $employees = $DBHCM->get_sql($mysql);
                                                $tblname = "view_department";
                                                $department = $DBHCM->get_data($tblname);
                                                $ddepartment = $department[0];
                                                $qdepartment = $department[1];
                                                ?>
                                                <option value=''>Select Status</option>
                                                <?php do { ?>
                                                    <option value="<?php echo $ddepartment['organization_name']; ?>" <?php if(isset($_GET['organization']) && $_GET['organization']==$ddepartment['organization_name']) { echo 'selected'; } ?>><?php echo $ddepartment['organization_name']; ?></option>
                                                <?php } while($ddepartment=$qdepartment->fetch_assoc()); ?>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-lg-12">Leader Name:</div>
                                    </div>
                                    <div class="rwo mb-3">
                                        <input type="text" class="form-control form-control-sm" name="leader" id="leader" value="<?php if(isset($_GET['leader'])) { echo $_GET['leader']; } ?>" placeholder="Leader Name">
                                    </div>
                                    <?php 
                                    $ref = $_SERVER["HTTP_REFERER"];
                                    if(isset($_GET['todo']) && $_GET['todo']=='list') {
                                    ?>
                                        <div class="row mb-3">
                                            <div class="col-lg-12">Employee Status</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-lg-12">
                                                <select class="form-select" name="status" aria-label="Default select example">
                                                    <option value="active">Active</option>
                                                    <option value="resign" <?php if(isset($_GET['status']) && $_GET['status']=='resign') { echo 'selected'; } ?>>Resign</option>
                                                </select>
                                            </div>
                                        </div>
                                    <?php } ?>
                                    <div class="row mb-3">
                                        <div class="col-lg-12">
                                            <input type="hidden" name="mod" value="employee_list">
                                            <input type="hidden" name="todo" value="<?php if(isset($_GET['todo'])) { echo $_GET['todo']; } ?>">
                                            <input type="submit" class="btn btn-primary" name="btn_search" id="btn_search" value="Search">
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="col-lg-10">
                                <div class="row mb-3">
                                    <?php 
                                    $tblname = "view_employees";
                                    $primarykey = "job_name";
                                    $condition='';
                                    $totalRows=0;
                                    $sambung="";
                                    if(isset($_GET['organization']) && $_GET['organization']!='') {
                                        $condition="organization_name = '" . $_GET['organization'] . "'";
                                        $sambung=" AND ";
                                    } 
                                    if(isset($_GET['leader']) && $_GET['leader']!='') {
                                        $condition .= $sambung . "leader_name LIKE '%" . $_GET['leader'] . "%' OR employee_name LIKE'%" . $_GET['leader'] . "%'";
                                        $totalRows=0;
                                        $sambung=" AND ";
                                    }
                                    if((isset($_GET['status']) && $_GET['status']=='active') || !isset($_GET['status'])) {
                                        $condition .= $sambung . " (resign_date = '0000-00-00' OR isnull(resign_date))";
                                        $totalRows=0;
                                    } elseif(isset($_GET['status']) && $_GET['status']=='resign') {
                                        $condition .= $sambung . " resign_date <> '0000-00-00'";
                                        $totalRows=0;
                                    }
                                    
                                    $order = "job_name DESC";

                                    view_table($DPNAV, $tblname, $primarykey, $condition, $order, $firstRow = 0, $totalRows)
                                    ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <?php 
        } else {
            echo "Aplikasi belum disetup";            
        }
    } else { 
        $ALERT->notpermission();
    }
} 
?>
