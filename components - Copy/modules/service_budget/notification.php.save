<?php
date_default_timezone_set( "Asia/Jakarta" );

$hostname = "10.20.50.161";
$username = "ITAdmin";
$password = "P@ssw0rd.1";

$dbname = "sa_md_hcm";
$DBHCM = new mysqli($hostname, $username, $password, $dbname);
$mysql = "SELECT employee_name, employee_email FROM sa_view_employees WHERE organization_name='Solution Architect and Telco'";
$res = mysqli_query( $DBHCM, $mysql ) or die($DBHCM->errno . "-" . "[open_db][mysqli_query][" . $mysql . "] - " . $DBHCM->error . "<br/>");
$row = mysqli_fetch_assoc( $res );

$bcc = '';
do {
//    $bcc .= $row['employees_name'] . "<" . $row['employee_email'] . ">,";
} while($row=$res->fetch_assoc());

//$bcc .= "Syamsul Arham<syamsul@mastersystem.co.id>, Fortuna Arumsari<fortuna@mastersystem.co.id>,Lucky<lucky.andiani@mastersystem.co.id>,Raymond Citra<raymon@mastersystem.co.id>";
$bcc .= "Syamsul Arham<syamsul@mastersystem.co.id>";
//$to = "Syamsul Arham<syamsul@mastersystem.co.id>";
$from="MSIZone<msizone@mastersystem.co.id>";
$subject="[MSIZone] Service Budget Reports " . date("F Y", strtotime("-30 day"));

$greating ='<p>Dear All,</p><p>Berikut ini merupakan report Service Budget untuk bulan ' . date("F Y", strtotime("-30 day")) . '. Silahkan ditindak lanjuti bila diperlukan.';

$msg ='
<table>
    <tr>
        <td style="width:20%; vertical-align:top; padding:10px; color:white" rowspan="7">
        </td>
        <td style="width:60%; border: thin solid #dadada; padding:20px 20px 20px 20px"><img src="https://msizone.mastersystem.co.id/media/images/profiles/Logo_MSIZone_204x74.png"></td>
        <td style="width:20%; rowspan="7"></td>
    </tr>
    <tr>
        <td style="width:60%; border: thin solid #dadada; height:5px; background:red"></td>
    </tr>
    <tr>
        <td style="width:60%; border: thin solid #dadada; padding:20px 20px 20px 20px">' . $greating . '</td>
    </tr>
    <tr>
        <td style="width:60%; border: thin solid #dadada; padding:20px 20px 20px 20px">';

$dbname = "sa_ps_service_budgets";
$DBSB = new mysqli($hostname, $username, $password, $dbname);

$msg .= '<table width="100%"><tr>';
    $condition = "status='draft'";
    $mysql = "SELECT * FROM sa_trx_project_list WHERE " . $condition;
    $res = mysqli_query( $DBSB, $mysql ) or die($$DBSB->errno . "-" . "[open_db][mysqli_query][" . $mysql . "] - " . $DBSB->error . "<br/>");
    $tdoc = mysqli_num_rows( $res ); 

$msg .= '<td style="width:25%; height:100px; vertical-align:midle; background:gray; font-size:18px; font-weight:bold; text-align:center; color:white;"><p>Draft</p><p>' . $tdoc . '</p></td>';

    $condition = "status='submited'";
    $mysql = "SELECT * FROM sa_trx_project_list WHERE " . $condition;
    $res = mysqli_query( $DBSB, $mysql ) or die($$DBSB->errno . "-" . "[open_db][mysqli_query][" . $mysql . "] - " . $DBSB->error . "<br/>");
    $tdoc = mysqli_num_rows( $res ); 

$msg .= '<td style="width:25%; height:100px; vertical-align:midle; background:purple; font-size:18px; font-weight:bold; text-align:center; color:white;"><p>Submited</p><p>' . $tdoc . '</p></td>';

    $condition = "status='approved' AND MONTH(modified_date)=\"" . date("m", strtotime("-30 day")) . "\" AND YEAR(modified_date)=\"" . date("Y", strtotime("-30 day")) . "\"";
    $mysql = "SELECT * FROM sa_trx_project_list WHERE " . $condition;
    $res = mysqli_query( $DBSB, $mysql ) or die($$DBSB->errno . "-" . "[open_db][mysqli_query][" . $mysql . "] - " . $DBSB->error . "<br/>");
    $tdoc = mysqli_num_rows( $res ); 

$msg .= '<td style="width:25%; height:100px; vertical-align:midle; background:teal; font-size:18px; font-weight:bold; text-align:center; color:white;"><p>Approved</p><p>' . $tdoc . '</p></td>';

    $condition = "status='rejected'";
    $mysql = "SELECT * FROM sa_trx_project_list WHERE " . $condition;
    $res = mysqli_query( $DBSB, $mysql ) or die($$DBSB->errno . "-" . "[open_db][mysqli_query][" . $mysql . "] - " . $DBSB->error . "<br/>");
    $tdoc = mysqli_num_rows( $res ); 

$msg .= '<td style="width:25%; height:100px; vertical-align:midle; background:orange; font-size:18px; font-weight:bold; text-align:center; color:white;"><p>Rejected</p><p>' . $tdoc . '</p></td>';

$msg .= '<tr></table>';

$dbname = "sa_msiguide";
$DBDOC = new mysqli($hostname, $username, $password, $dbname);
$mysql = "SELECT post_title, post_modified, post_name FROM wp_posts WHERE post_status='publish' AND post_type='post' AND post_title LIKE'%Service Budget%' ORDER BY post_modified DESC LIMIT 0,5";
mysqli_set_charset( $DBDOC, 'utf8' );
$res = mysqli_query( $DBDOC, $mysql ) or die($$DBDOC->errno . "-" . "[open_db][mysqli_query][" . $mysql . "] - " . $DBDOC->error . "<br/>");
$row = mysqli_fetch_assoc( $res );
$total_rows = mysqli_num_rows( $res ); 

$msg .='
        </td>
    </tr>
    <tr>
        <td style="width:60%; border: thin solid #dadada">
            <table width="100%">
            <tr><td style="width:50%; padding:20px 20px 20px 20px">
            <div style="font-weight:bold; vertical-align:top; border-bottom:red thin solid; margin-bottom:5px">Service Budget Update</div>';
             do {
             do {
                $titleexp = explode(":", $row['post_title']);
                if(count($titleexp)>1) {
                    $title = $titleexp[1];
                } else {
                    $title = $titleexp[0];
                }
                  $msg .= '<p><span style="font-color:#000;"><a href="https://msizone.mastersystem.co.id/msiguide/' . $row['post_name'] . '" target="_blank" style="color:black;text-decoration: none;">' . $row["post_title"] . '</a></span><br/>';
              } while($row=$res->fetch_assoc());
$msg .= '</td>';

$mysql = "SELECT post_title, post_modified, post_name FROM wp_posts WHERE post_status='publish' AND post_type='post' AND post_title LIKE'%MSIZone%' ORDER BY post_modified DESC LIMIT 0,2";
mysqli_set_charset( $DBDOC, 'utf8' );
$res = mysqli_query( $DBDOC, $mysql ) or die($$DBDOC->errno . "-" . "[open_db][mysqli_query][" . $mysql . "] - " . $DBDOC->error . "<br/>");
$row = mysqli_fetch_assoc( $res );

$msg .= '          <td style="vertical-align:top; width:50%; padding:20px 20px 20px 20px"">
                   <div style="font-weight:bold; vertical-align:top; border-bottom:red thin solid; margin-bottom:5px">MSIZone Update</div>';
                    do {
                        $msg .= '<p><span style="font-color:#000;"><a href="https://msizone.mastersystem.co.id/msiguide/' . $row['post_name'] . '" target="_blank" style="color:black;text-decoration: none;">' . $row["post_title"] . '</a></span><br/>';
                    } while($row=$res->fetch_assoc());
                   $msg .='<div style="font-weight:bold; vertical-align:top; border-bottom:red thin solid; margin-bottom:5px">MSIZone Link</div>
                   <p><a href="https://msizone.mastersystem.co.id" target="_blank" style="color:black;text-decoration: none;">MSIZone</a></p>
                   <p><a href="https://msizone.mastersystem.co.id/msiguide" target="_blank" style="color:black;text-decoration: none;">MSIGuide</a></p>
               </td>
            </tr></table>';
 $msg .='</td>
    </tr>
    <tr>
        <td style="width:60%; border: thin solid #dadada; padding:10px 20px 10px 20px; font-size:10px">Dikirim secara otomatis oleh sistem MSIZone.<br/>
Jangan membalas/reply email ini.</td>
    </tr>
</table>';

$headers = "From: " . $from . "\r\n" .
    "Bcc: " . $bcc . "\r\n" .
    "MIME-Version: 1.0" . "\r\n" .
    "Content-Type: text/html; charset=UTF-8" . "\r\n" .
    "X-Mailer: PHP/" . phpversion();
    
if(mail($to, $subject, $msg, $headers)) {
    echo "Email terkirim pada jam " . date("d M Y G:i:s");
} else {
   echo "Email gagal terkirim pada jam " . date("d M Y G:i:s");
}
?>
